name: Build macOS DMG

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt pyinstaller

      - name: Build app with PyInstaller
        run: |
          pyinstaller --windowed --name "Convertly" \
            --osx-bundle-identifier "com.ibrahimezzeldin.convertly" \
            --collect-all pdf2docx \
            --collect-all pdfplumber \
            --collect-all reportlab \
            converter.py

      - name: Stamp developer metadata into app bundle
        run: |
          PLIST="dist/Convertly.app/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :NSHumanReadableCopyright string 'Copyright Â© 2025 Ibrahim Ezzeldin Mirghani. All rights reserved.'" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string '2.0'" "$PLIST" || \
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString '2.0'" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string '2.0.0'" "$PLIST" || \
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion '2.0.0'" "$PLIST"

      - name: Package into DMG
        run: |
          mkdir dmg_staging
          cp -r dist/Convertly.app dmg_staging/
          ln -s /Applications dmg_staging/Applications
          hdiutil create -volname "Convertly" \
            -srcfolder dmg_staging -ov -format UDZO \
            Convertly-macOS.dmg

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: Convertly-macOS
          path: Convertly-macOS.dmg
